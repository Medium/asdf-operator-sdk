#!/usr/bin/env bash

set -eo pipefail

install_operator_sdk() {
  install_type=$1
  version=$2
  install_path=$3

  if [ "$install_type" != "version" ]; then
    echo "asdf-operator-sdk supports release installs only"
    exit 1
  fi

  os="$(uname | tr '[:upper:]' '[:lower:]')"

  if [ "$os" = "darwin" ]; then
    os="apple-$os"
  elif [ "$os" = "linux" ]; then
    os="$os-gnu"
  fi

  platform="$(uname -m)-$os"
  bin_install_path="$install_path/bin"
  binary_path="$bin_install_path/operator-sdk"
  download_url="$(get_download_url "$version" "$platform")"

  if [ "$TMPDIR" = "" ]; then
    tmp_download_dir="$(mktemp -d -t operator-sdk_XXXXXX)"
  else
    tmp_download_dir=$TMPDIR
  fi

  download_path="$tmp_download_dir/$(get_filename "$version" "$platform")"

  echo "Downloading operator-sdk from $download_url to $download_path"
  curl -Lo "$download_path" "$download_url"

  echo "Creating bin directory"
  mkdir -p "$bin_install_path"

  echo "Cleaning previous binaries"
  rm -f "$binary_path" 2>/dev/null || true

  echo "Copying binary"
  cp "$download_path" "$binary_path"
  chmod +x "$binary_path"
}

get_filename() {
  version="$1"
  platform="$2"

  echo "operator-sdk-v$version-$platform"
}

get_download_url() {
  version="$1"
  platform="$2"
  filename="$(get_filename "$version" "$platform")"
  echo "https://github.com/operator-framework/operator-sdk/releases/download/v$version/$filename"
}

install_operator_sdk "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
